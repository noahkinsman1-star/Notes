<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1Notes</title>

<link rel="manifest" href="manifest.json">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #fff;
}

/* Notes list */
#notesList {
  padding: 12px;
  border-bottom: 1px solid #ddd;
}

.note-item {
  padding: 10px;
  border-radius: 8px;
  background: #f5f5f5;
  margin-bottom: 8px;
  cursor: pointer;
}

.note-item strong {
  display: block;
}

/* Editor */
#editor {
  padding: 16px;
  padding-bottom: 100px;
}

.line {
  outline: none;
  margin: 4px 0;
  line-height: 1.35;
}

.normal {
  font-size: 18px;
  font-weight: 400;
}

.title {
  font-size: 28px;
  font-weight: 700;
}

.subtitle {
  font-size: 22px;
  font-weight: 600;
  color: #000;
}

/* Toolbar */
.toolbar {
  position: fixed;
  left: 0;
  width: 100%;
  display: flex;
  gap: 6px;
  padding: 8px;
  background: #f2f2f2;
  border-top: 1px solid #ddd;
  z-index: 100;
}

.toolbar button {
  padding: 6px 10px;
  font-size: 14px;
  border: none;
  border-radius: 6px;
  background: #e0e0e0;
}

.toolbar button:active {
  background: #cfcfcf;
  transform: scale(0.95);
}
</style>
</head>

<body>

<div id="notesList"></div>
<div id="editor"></div>

<div class="toolbar" id="toolbar">
  <button onclick="newNote()">＋</button>
  <button onclick="setLineStyle('title')">Title</button>
  <button onclick="setLineStyle('subtitle')">Subtitle</button>
  <button onclick="setLineStyle('normal')">Text</button>
  <button onclick="formatText('bold')"><b>B</b></button>
  <button onclick="formatText('italic')"><i>I</i></button>
  <button onclick="formatText('underline')"><u>U</u></button>
  <button onclick="insertBullet()">•</button>
  <button onclick="insertCheckbox()">☐</button>
</div>

<script>
const editor = document.getElementById("editor");
const toolbar = document.getElementById("toolbar");
const notesList = document.getElementById("notesList");

let notes = JSON.parse(localStorage.getItem("notes")) || [];
let currentNoteId = null;
let currentLine = null;

/* ---------- Toolbar position ---------- */
function updateToolbarPosition() {
  if (!window.visualViewport) return;
  const keyboardHeight =
    window.innerHeight -
    window.visualViewport.height -
    window.visualViewport.offsetTop;

  toolbar.style.bottom = keyboardHeight > 100
    ? keyboardHeight + "px"
    : "0px";
}

if (window.visualViewport) {
  window.visualViewport.addEventListener("resize", updateToolbarPosition);
  window.visualViewport.addEventListener("scroll", updateToolbarPosition);
}

/* ---------- Notes ---------- */
function saveNotes() {
  localStorage.setItem("notes", JSON.stringify(notes));
}

function saveOrDeleteCurrentNote() {
  if (!currentNoteId) return;

  const text = editor.innerText.trim();
  const index = notes.findIndex(n => n.id === currentNoteId);

  if (index === -1) return;

  if (text === "") {
    notes.splice(index, 1);
  } else {
    notes[index].content = editor.innerHTML;
    notes[index].lastEdited = Date.now();
  }

  saveNotes();
  renderNotesList();
  currentNoteId = null;
}

function newNote() {
  saveOrDeleteCurrentNote();

  const id = Date.now().toString();
  notes.push({ id, content: "", lastEdited: Date.now() });
  currentNoteId = id;

  editor.innerHTML = "";
  createLine();
  renderNotesList();
}

function openNote(id) {
  saveOrDeleteCurrentNote();

  const note = notes.find(n => n.id === id);
  if (!note) return;

  currentNoteId = id;
  editor.innerHTML = note.content || "";
  if (editor.innerHTML === "") createLine();
}

/* ---------- Notes list ---------- */
function renderNotesList() {
  notesList.innerHTML = "";

  notes
    .sort((a, b) => b.lastEdited - a.lastEdited)
    .forEach(note => {
      const div = document.createElement("div");
      div.className = "note-item";

      const preview = note.content
        ? note.content.replace(/<[^>]+>/g, "").slice(0, 40)
        : "New Note";

      div.innerHTML = `<strong>${preview || "New Note"}</strong>`;
      div.onclick = () => openNote(note.id);

      notesList.appendChild(div);
    });
}

/* ---------- Editor ---------- */
function createLine(type = "normal", after = null) {
  const div = document.createElement("div");
  div.className = `line ${type}`;
  div.contentEditable = true;

  if (after) editor.insertBefore(div, after.nextSibling);
  else editor.appendChild(div);

  currentLine = div;
  placeCaretAtEnd(div);

  div.addEventListener("focus", () => currentLine = div);

  div.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      createLine("normal", div);
    }

    if (e.key === "Backspace" && div.textContent === "") {
      const prev = div.previousElementSibling;
      if (prev) {
        e.preventDefault();
        div.remove();
        placeCaretAtEnd(prev);
      }
    }
  });

  div.addEventListener("click", () => {
    if (div.textContent.startsWith("☐ ")) {
      div.textContent = "☑ " + div.textContent.slice(2);
      placeCaretAtEnd(div);
    } else if (div.textContent.startsWith("☑ ")) {
      div.textContent = "☐ " + div.textContent.slice(2);
      placeCaretAtEnd(div);
    }
  });
}

/* ---------- Formatting ---------- */
function setLineStyle(type) {
  if (!currentLine) return;
  currentLine.className = `line ${type}`;
  currentLine.focus();
}

function formatText(cmd) {
  document.execCommand(cmd);
}

function insertBullet() {
  document.execCommand("insertUnorderedList");
}

function insertCheckbox() {
  document.execCommand("insertText", false, "☐ ");
}

function placeCaretAtEnd(el) {
  el.focus();
  const range = document.createRange();
  range.selectNodeContents(el);
  range.collapse(false);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}

/* ---------- Start ---------- */
renderNotesList();
newNote();
updateToolbarPosition();
</script>

</body>
</html>
